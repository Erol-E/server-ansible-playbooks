---
- include_tasks: redhat.yml
  when: ansible_os_family == 'RedHat'

- include_tasks: debian.yml
  when: ansible_os_family == 'Debian'

- name: Ensure Varnish config path exists.
  file:
    path: "{{ varnish.config_path }}"
    state: directory

- name: Copy Varnish default VCL.
  template:
    src: "{{ varnish.default_vcl_template_path }}"
    dest: "{{ varnish.config_path }}/default.vcl"
    owner: root
    group: root
    mode: 0644
  when: varnish.use_default_vcl
  notify: restart varnish
  tags:
    - varnish

- name: Copy Varnish systemd configuration.
  template:
    src: varnish.service.j2
    dest: /etc/systemd/system/varnish.service
    owner: root
    group: root
    mode: 0755
  when: (ansible_distribution == "CentOS" and ansible_distribution_major_version >= "7") or (ansible_distribution == "Debian" and ansible_distribution_major_version >= "8") or (ansible_distribution == "Ubuntu" and ansible_distribution_major_version >= "16")
  tags:
    - varnish

- name: Copy Varnish configuration.
  template:
    src: varnish.j2
    dest: /etc/default/varnish
    owner: root
    group: root
    mode: 0755
  tags:
    - varnish

# Old versions of OS use "service" for start|stop|etc services.
- name: putting into autostart
  service:
    name=varnish
    state=started
    enabled=yes
  when: (ansible_distribution == "CentOS" and ansible_distribution_major_version == "6") or (ansible_distribution == "Debian" and ansible_distribution_major_version == "7") or (ansible_distribution == "Ubuntu" and ansible_distribution_major_version == "14")
  tags:
    - varnish

# Current versions of OS use "systemd" for start|stop|etc services.
- name: putting into autostart
  systemd:
    name=varnish
    state=started
    enabled=yes
    daemon_reload=yes
    masked=no
  when: (ansible_distribution == "CentOS" and ansible_distribution_major_version >= "7") or (ansible_distribution == "Debian" and ansible_distribution_major_version >= "8") or (ansible_distribution == "Ubuntu" and ansible_distribution_major_version >= "16")
  tags:
    - varnish